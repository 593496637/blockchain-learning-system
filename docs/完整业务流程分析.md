# å®Œæ•´ä¸šåŠ¡æµç¨‹åˆ†æ

## 1. ç³»ç»Ÿå¯åŠ¨æµç¨‹

### 1.1 åç«¯å¯åŠ¨åºåˆ—

```typescript
// 1. åˆ›å»ºåŒºå—é“¾å®ä¾‹
const blockchain = new Blockchain();

// 2. é…ç½®ExpressæœåŠ¡å™¨
const app = express();
app.use(cors());
app.use(express.json());

// 3. å¯åŠ¨æœåŠ¡å™¨
app.listen(PORT, () => {
  console.log('ğŸš€ åŒºå—é“¾å­¦ä¹ ç³»ç»Ÿå¯åŠ¨æˆåŠŸï¼');
  
  // 4. åˆ›å»ºæµ‹è¯•æ•°æ®
  const alice = blockchain.createUser('Alice');
  const bob = blockchain.createUser('Bob');
  
  // 5. åˆ†é…åˆå§‹ä»£å¸
  blockchain.allocateTokens(alice.address, 100);
  blockchain.allocateTokens(bob.address, 50);
  
  // 6. æ³¨å†Œæµ‹è¯•çŸ¿å·¥
  const miner1 = blockchain.registerMiner('Miner_Alpha');
  const miner2 = blockchain.registerMiner('Miner_Beta');
});
```

**å¯åŠ¨è¿‡ç¨‹è¯´æ˜ï¼š**
1. è‡ªåŠ¨åˆ›å»ºåˆ›ä¸–å—ï¼ˆindex: 0ï¼‰
2. åˆå§‹åŒ–ç©ºçš„äº¤æ˜“æ± 
3. è®¾ç½®ç³»ç»Ÿé…ç½®å‚æ•°
4. åˆ›å»ºæ¼”ç¤ºç”¨æµ‹è¯•æ•°æ®

### 1.2 å‰ç«¯å¯åŠ¨åºåˆ—

```typescript
function App() {
  useEffect(() => {
    // 1. é¦–æ¬¡åŠ è½½ç³»ç»Ÿä¿¡æ¯
    loadSystemInfo();
    
    // 2. è®¾ç½®å®šæ—¶åˆ·æ–°ï¼ˆæ¯10ç§’ï¼‰
    const interval = setInterval(loadSystemInfo, 10000);
    
    // 3. æ¸…ç†å®šæ—¶å™¨
    return () => clearInterval(interval);
  }, []);

  const loadSystemInfo = async () => {
    try {
      setConnectionStatus('connecting');
      
      // å¹¶è¡Œè·å–æ•°æ®
      const [infoResponse, usersResponse] = await Promise.all([
        api.getBlockchainInfo(),
        api.getUsers()
      ]);
      
      // æ›´æ–°çŠ¶æ€
      if (infoResponse.success) setBlockchainInfo(infoResponse.data);
      if (usersResponse.success) setUsers(usersResponse.data);
      
      setConnectionStatus('connected');
    } catch (error) {
      setConnectionStatus('disconnected');
    }
  };
}
```

## 2. å®Œæ•´äº¤æ˜“æµç¨‹è¯¦è§£

### 2.1 ç”¨æˆ·åˆ›å»ºäº¤æ˜“ï¼ˆå‰ç«¯ï¼‰

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·ç•Œé¢
    participant Form as äº¤æ˜“è¡¨å•
    participant API as APIå±‚
    participant Backend as åç«¯æœåŠ¡
    participant Blockchain as åŒºå—é“¾

    User->>Form: å¡«å†™äº¤æ˜“ä¿¡æ¯
    Form->>Form: å‰ç«¯éªŒè¯
    Note over Form: æ£€æŸ¥ä½™é¢ã€å‚æ•°æœ‰æ•ˆæ€§
    Form->>API: createTransaction()
    API->>Backend: POST /api/transactions
    Backend->>Blockchain: blockchain.createTransaction()
    Blockchain->>Blockchain: éªŒè¯ç”¨æˆ·ã€ä½™é¢
    Blockchain->>Blockchain: åˆ›å»ºäº¤æ˜“å¯¹è±¡
    Blockchain->>Blockchain: åŠ å…¥äº¤æ˜“æ± 
    Backend-->>API: è¿”å›äº¤æ˜“ID
    API-->>Form: æˆåŠŸå“åº”
    Form->>User: æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
```

### 2.2 äº¤æ˜“åˆ›å»ºè¯¦ç»†æ­¥éª¤

#### å‰ç«¯éªŒè¯é˜¶æ®µ
```typescript
const createTransaction = async () => {
  // 1. åŸºç¡€å‚æ•°éªŒè¯
  if (!fromUser || !toUser || amount <= 0) {
    setMessage('è¯·å¡«å†™å®Œæ•´çš„äº¤æ˜“ä¿¡æ¯');
    return;
  }

  // 2. é€»è¾‘éªŒè¯
  if (fromUser === toUser) {
    setMessage('å‘é€æ–¹å’Œæ¥æ”¶æ–¹ä¸èƒ½ç›¸åŒ');
    return;
  }

  // 3. ä½™é¢é¢„æ£€æŸ¥ï¼ˆå‰ç«¯ä¼˜åŒ–ï¼‰
  const sender = users.find(u => u.address === fromUser);
  if (sender && sender.balance < amount + 0.1) {
    setMessage('ä½™é¢ä¸è¶³ï¼ˆåŒ…å«æ‰‹ç»­è´¹0.1ä»£å¸ï¼‰');
    return;
  }

  // 4. å‘é€APIè¯·æ±‚
  const response = await api.createTransaction(fromUser, toUser, amount);
};
```

#### åç«¯å¤„ç†é˜¶æ®µ
```typescript
app.post('/api/transactions', (req, res) => {
  try {
    const { from, to, amount } = req.body;
    
    // 1. å‚æ•°éªŒè¯
    if (!from || !to || !amount || amount <= 0) {
      return res.status(400).json({
        success: false,
        error: 'äº¤æ˜“å‚æ•°æ— æ•ˆ'
      });
    }

    // 2. è°ƒç”¨åŒºå—é“¾å¤„ç†
    const transactionId = blockchain.createTransaction(from, to, amount);
    
    // 3. è¿”å›ç»“æœ
    if (transactionId) {
      res.json({
        success: true,
        data: { transactionId },
        message: 'äº¤æ˜“å·²åˆ›å»ºå¹¶åŠ å…¥äº¤æ˜“æ± '
      });
    } else {
      res.status(400).json({
        success: false,
        error: 'äº¤æ˜“åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä½™é¢å’Œè´¦æˆ·'
      });
    }
  } catch (error) {
    res.status(500).json({
      success: false,
      error: 'åˆ›å»ºäº¤æ˜“å¤±è´¥'
    });
  }
});
```

#### åŒºå—é“¾æ ¸å¿ƒå¤„ç†
```typescript
createTransaction(from: string, to: string, amount: number): string | null {
  // 1. è·å–ç”¨æˆ·ä¿¡æ¯
  const sender = this.users.get(from);
  const receiver = this.users.get(to);

  // 2. éªŒè¯ç”¨æˆ·å­˜åœ¨
  if (!sender || !receiver) {
    return null;
  }

  // 3. è®¡ç®—æ€»è´¹ç”¨
  const totalCost = amount + this.config.minFee;
  
  // 4. éªŒè¯ä½™é¢
  if (sender.balance < totalCost) {
    return null;
  }

  // 5. åˆ›å»ºäº¤æ˜“å¯¹è±¡
  const transaction: Transaction = {
    id: uuidv4(),
    from, to, amount,
    fee: this.config.minFee,
    timestamp: Date.now(),
    status: 'pending'
  };

  // 6. åŠ å…¥äº¤æ˜“æ± 
  this.pendingTransactions.push(transaction);
  return transaction.id;
}
```

## 3. æŒ–çŸ¿æµç¨‹è¯¦è§£

### 3.1 æŒ–çŸ¿è§¦å‘æµç¨‹

```mermaid
sequenceDiagram
    participant Miner as çŸ¿å·¥ç•Œé¢
    participant API as APIå±‚
    participant Backend as åç«¯
    participant Blockchain as åŒºå—é“¾
    participant TxPool as äº¤æ˜“æ± 

    Miner->>API: mineBlock(minerAddress)
    API->>Backend: POST /api/mining/mine
    Backend->>Blockchain: blockchain.mineBlock()
    Blockchain->>TxPool: è·å–å¾…å¤„ç†äº¤æ˜“
    TxPool-->>Blockchain: è¿”å›äº¤æ˜“åˆ—è¡¨
    Blockchain->>Blockchain: éªŒè¯äº¤æ˜“
    Blockchain->>Blockchain: åˆ›å»ºæ–°åŒºå—
    Blockchain->>Blockchain: å·¥ä½œé‡è¯æ˜è®¡ç®—
    Note over Blockchain: å¯»æ‰¾æ»¡è¶³éš¾åº¦çš„nonce
    Blockchain->>Blockchain: åŠ å…¥åŒºå—é“¾
    Blockchain->>Blockchain: å¥–åŠ±çŸ¿å·¥
    Blockchain->>TxPool: ç§»é™¤å·²å¤„ç†äº¤æ˜“
    Backend-->>API: è¿”å›æ–°åŒºå—
    API-->>Miner: æ˜¾ç¤ºæŒ–çŸ¿ç»“æœ
```

### 3.2 å·¥ä½œé‡è¯æ˜ç®—æ³•è¯¦è§£

```typescript
// æŒ–çŸ¿æ ¸å¿ƒç®—æ³•
mineBlock(minerAddress: string): Block | null {
  // 1. å‡†å¤‡é˜¶æ®µ
  const miner = this.miners.get(minerAddress);
  if (!miner?.isActive) return null;

  // 2. é€‰æ‹©äº¤æ˜“
  const transactionsToMine = this.pendingTransactions
    .slice(0, this.config.maxTransactionsPerBlock);

  if (transactionsToMine.length === 0) return null;

  // 3. éªŒè¯å¹¶å¤„ç†äº¤æ˜“
  const validTransactions: Transaction[] = [];
  for (const tx of transactionsToMine) {
    if (this.validateAndProcessTransaction(tx)) {
      validTransactions.push(tx);
    }
  }

  // 4. åˆ›å»ºå€™é€‰åŒºå—
  const newBlock: Block = {
    index: this.chain.length,
    timestamp: Date.now(),
    transactions: validTransactions,
    previousHash: this.getLatestBlock().hash,
    hash: '',
    nonce: 0,
    miner: minerAddress,
    reward: this.config.blockReward
  };

  // 5. å·¥ä½œé‡è¯æ˜è®¡ç®—
  const startTime = Date.now();
  while (true) {
    // è®¡ç®—å½“å‰å“ˆå¸Œ
    newBlock.hash = this.calculateHash(newBlock);
    
    // æ£€æŸ¥æ˜¯å¦æ»¡è¶³éš¾åº¦è¦æ±‚
    if (newBlock.hash.substring(0, this.config.difficulty) === 
        '0'.repeat(this.config.difficulty)) {
      break; // æ‰¾åˆ°æœ‰æ•ˆå“ˆå¸Œ
    }
    
    newBlock.nonce++; // å¢åŠ éšæœºæ•°é‡è¯•
  }
  const miningTime = Date.now() - startTime;

  // 6. å®ŒæˆæŒ–çŸ¿
  this.chain.push(newBlock);                    // åŠ å…¥ä¸»é“¾
  this.rewardMiner(minerAddress, newBlock.reward, validTransactions); // å¥–åŠ±çŸ¿å·¥
  this.pendingTransactions = this.pendingTransactions  // æ¸…ç†äº¤æ˜“æ± 
    .filter(tx => !validTransactions.find(vtx => vtx.id === tx.id));

  return newBlock;
}
```

### 3.3 äº¤æ˜“éªŒè¯ä¸æ‰§è¡Œ

```typescript
private validateAndProcessTransaction(transaction: Transaction): boolean {
  const sender = this.users.get(transaction.from);
  const receiver = this.users.get(transaction.to);

  // éªŒè¯ç”¨æˆ·å­˜åœ¨
  if (!sender || !receiver) return false;

  // éªŒè¯ä½™é¢å……è¶³
  const totalCost = transaction.amount + transaction.fee;
  if (sender.balance < totalCost) return false;

  // æ‰§è¡Œè½¬è´¦ï¼ˆåŸå­æ“ä½œï¼‰
  sender.balance -= totalCost;              // æ‰£é™¤å‘é€æ–¹
  receiver.balance += transaction.amount;   // å¢åŠ æ¥æ”¶æ–¹
  transaction.status = 'confirmed';         // æ ‡è®°å·²ç¡®è®¤

  return true;
}
```

## 4. æ•°æ®åŒæ­¥æœºåˆ¶

### 4.1 å‰ç«¯æ•°æ®æµ

```typescript
// ä¸»åº”ç”¨æ•°æ®æµ
App (å…¨å±€çŠ¶æ€)
 â”œâ”€â”€ loadSystemInfo() - å®šæ—¶è·å–ç³»ç»Ÿä¿¡æ¯
 â”œâ”€â”€ blockchainInfo - åŒºå—é“¾çŠ¶æ€
 â”œâ”€â”€ users - ç”¨æˆ·åˆ—è¡¨ç¼“å­˜
 â””â”€â”€ connectionStatus - è¿æ¥çŠ¶æ€

// ç»„ä»¶é—´é€šä¿¡
UserManagement
 â”œâ”€â”€ æœ¬åœ°çŠ¶æ€ç®¡ç†è¾“å…¥
 â”œâ”€â”€ æ“ä½œå®Œæˆåè°ƒç”¨ onRefresh()
 â””â”€â”€ é€šçŸ¥ App ç»„ä»¶åˆ·æ–°å…¨å±€æ•°æ®

TransactionManagement
 â”œâ”€â”€ æ¥æ”¶ users å±æ€§ï¼ˆæ¥è‡ªAppï¼‰
 â”œâ”€â”€ åˆ›å»ºäº¤æ˜“ååˆ·æ–°äº¤æ˜“æ± 
 â””â”€â”€ è°ƒç”¨ onRefresh() æ›´æ–°ç³»ç»ŸçŠ¶æ€

MinerManagement
 â”œâ”€â”€ æŒ–çŸ¿åå…¨é¢åˆ·æ–°æ•°æ®
 â””â”€â”€ è§¦å‘çˆ¶ç»„ä»¶æ•°æ®æ›´æ–°
```

### 4.2 å®æ—¶æ›´æ–°ç­–ç•¥

```typescript
// å®šæ—¶åˆ·æ–°æœºåˆ¶
useEffect(() => {
  loadSystemInfo();
  const interval = setInterval(loadSystemInfo, 10000); // 10ç§’
  return () => clearInterval(interval);
}, []);

// æ“ä½œè§¦å‘åˆ·æ–°
const handleRefresh = () => {
  loadSystemInfo(); // ç«‹å³åˆ·æ–°
};

// ç»„ä»¶çº§åˆ«åˆ·æ–°
const createUser = async () => {
  // ... åˆ›å»ºç”¨æˆ·é€»è¾‘
  if (response.success) {
    await loadUsers();    // åˆ·æ–°æœ¬åœ°ç”¨æˆ·åˆ—è¡¨
    onRefresh();          // è§¦å‘å…¨å±€åˆ·æ–°
  }
};
```

## 5. é”™è¯¯å¤„ç†ä¸æ¢å¤

### 5.1 åˆ†å±‚é”™è¯¯å¤„ç†

```typescript
// APIå±‚é”™è¯¯å¤„ç†
const handleApiRequest = async <T>(request: () => Promise<T>): Promise<ApiResponse<T>> => {
  try {
    const data = await request();
    return { success: true, data };
  } catch (error) {
    console.error('API Error:', error);
    return { 
      success: false, 
      error: error instanceof Error ? error.message : 'Unknown error' 
    };
  }
};

// ç»„ä»¶å±‚é”™è¯¯å¤„ç†
const createUser = async () => {
  setLoading(true);
  try {
    const response = await api.createUser(newUserName);
    if (response.success) {
      setMessage('ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼');
    } else {
      setMessage(`åˆ›å»ºå¤±è´¥: ${response.error}`);
    }
  } catch (error) {
    setMessage('åˆ›å»ºç”¨æˆ·æ—¶å‘ç”Ÿé”™è¯¯');
  } finally {
    setLoading(false);
  }
};

// è¿æ¥çŠ¶æ€æ¢å¤
const loadSystemInfo = async () => {
  try {
    setConnectionStatus('connecting');
    // ... APIè°ƒç”¨
    setConnectionStatus('connected');
  } catch (error) {
    setConnectionStatus('disconnected');
    // é”™è¯¯çŠ¶æ€ä¸‹ä¸é˜»å¡ç”¨æˆ·æ“ä½œ
  }
};
```

### 5.2 ç”¨æˆ·ä½“éªŒä¼˜åŒ–

```typescript
// åŠ è½½çŠ¶æ€åé¦ˆ
{loading ? (
  <button disabled className="loading">
    æ“ä½œä¸­...
  </button>
) : (
  <button onClick={handleSubmit}>
    æäº¤
  </button>
)}

// è¿æ¥çŠ¶æ€æŒ‡ç¤º
<div className={`status ${connectionStatus}`}>
  {connectionStatus === 'connected' && 'âœ… å·²è¿æ¥'}
  {connectionStatus === 'connecting' && 'ğŸ”„ è¿æ¥ä¸­'}
  {connectionStatus === 'disconnected' && 'âŒ è¿æ¥å¤±è´¥'}
</div>

// è‡ªåŠ¨æ¶ˆæ¯æ¸…é™¤
useEffect(() => {
  if (message) {
    const timer = setTimeout(() => setMessage(''), 5000);
    return () => clearTimeout(timer);
  }
}, [message]);
```

## 6. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 6.1 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

```typescript
// æ•°æ®ç¼“å­˜
const [cache, setCache] = useState<{
  users: User[];
  blocks: Block[];
  lastUpdate: number;
}>({
  users: [],
  blocks: [],
  lastUpdate: 0
});

// é¿å…é‡å¤è¯·æ±‚
const loadUsers = async (forceRefresh = false) => {
  const cacheValid = Date.now() - cache.lastUpdate < 30000; // 30ç§’ç¼“å­˜
  
  if (!forceRefresh && cacheValid && cache.users.length > 0) {
    return cache.users;
  }
  
  const response = await api.getUsers();
  if (response.success) {
    setCache(prev => ({
      ...prev,
      users: response.data!,
      lastUpdate: Date.now()
    }));
  }
};

// ç»„ä»¶ä¼˜åŒ–
const BlockItem = React.memo<{ block: Block }>(({ block }) => (
  <div className="block-item">
    <div>åŒºå— #{block.index}</div>
    <div>äº¤æ˜“æ•°: {block.transactions.length}</div>
  </div>
));
```

### 6.2 åç«¯æ€§èƒ½è€ƒè™‘

```typescript
// æ•°æ®ç»“æ„ä¼˜åŒ–
private users: Map<string, User> = new Map();    // O(1) æŸ¥æ‰¾
private miners: Map<string, Miner> = new Map();  // O(1) æŸ¥æ‰¾
private chain: Block[] = [];                     // é¡ºåºè®¿é—®

// äº¤æ˜“æ± ç®¡ç†
private pendingTransactions: Transaction[] = [];

// é™åˆ¶æ¯æ¬¡å¤„ç†çš„äº¤æ˜“æ•°é‡
const transactionsToMine = this.pendingTransactions
  .slice(0, this.config.maxTransactionsPerBlock);

// å†…å­˜å­˜å‚¨çš„ä¼˜åŠ¿
// - æ— I/Oå»¶è¿Ÿ
// - é€‚åˆæ¼”ç¤ºå’Œå­¦ä¹ 
// - ç®€åŒ–å®ç°å¤æ‚åº¦
```

## 7. å®‰å…¨æœºåˆ¶

### 7.1 å‰ç«¯å®‰å…¨éªŒè¯

```typescript
// è¾“å…¥éªŒè¯
const validateInput = (value: string, type: string) => {
  switch (type) {
    case 'amount':
      return value && parseFloat(value) > 0;
    case 'address':
      return value && value.length === 40; // åœ°å€é•¿åº¦æ£€æŸ¥
    default:
      return true;
  }
};

// ä½™é¢é¢„æ£€æŸ¥
const checkBalance = (userAddress: string, amount: number) => {
  const user = users.find(u => u.address === userAddress);
  return user && user.balance >= amount + 0.1; // åŒ…å«æ‰‹ç»­è´¹
};
```

### 7.2 åç«¯å®‰å…¨ä¿éšœ

```typescript
// ä¸¥æ ¼çš„ä½™é¢éªŒè¯
if (sender.balance < totalCost) {
  return null; // é˜»æ­¢è¶…é¢æ”¯ä»˜
}

// åŸå­æ€§äº¤æ˜“å¤„ç†
private validateAndProcessTransaction(transaction: Transaction): boolean {
  // éªŒè¯ -> æ‰§è¡Œ -> ç¡®è®¤ï¼Œä¸‰æ­¥ä¸€ä½“
  if (éªŒè¯é€šè¿‡) {
    æ‰§è¡Œè½¬è´¦();
    æ ‡è®°ç¡®è®¤();
    return true;
  }
  return false;
}

// å“ˆå¸Œå®Œæ•´æ€§
private calculateHash(block: Block): string {
  // åŒ…å«æ‰€æœ‰å…³é”®å­—æ®µï¼Œç¡®ä¿ä¸å¯ç¯¡æ”¹
  const data = block.index + block.previousHash + /* ... */;
  return crypto.createHash('sha256').update(data).digest('hex');
}
```

è¿™ä¸ªå®Œæ•´çš„ä¸šåŠ¡æµç¨‹åˆ†æå±•ç¤ºäº†åŒºå—é“¾å­¦ä¹ ç³»ç»Ÿä»ç”¨æˆ·æ“ä½œåˆ°åº•å±‚å¤„ç†çš„å…¨è¿‡ç¨‹ï¼ŒåŒ…æ‹¬æ•°æ®æµã€é”™è¯¯å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–å’Œå®‰å…¨æœºåˆ¶ç­‰å…³é”®ç¯èŠ‚ã€‚